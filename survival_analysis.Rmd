---
title: "Survival Analysis of Diabetes Incidence"
author: "Lauren Bastian"
date: "3/30/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Study of Women's Health Across the Nation
---------------
The data come from the Study of Women's Health Across the Nation (SWAN), a longitudinal population-based study of 3302 middle-aged women with data collected between 1998 and 2008, with data made public for research purposes through [ICPSR](https://www.icpsr.umich.edu/web/ICPSR/series/00253). The analytical sample contains 2686 records of middle-aged women who participated in the study and had complete observations for race, baseline BMI, baseline household income, and health insurance. Race, household income, and insurance status were assessed during a baseline visit and are assumed to be indicative of race, household income, and insurance status throughout the study. Diabetes status was assessed during baseline as whether or not the individual was currently treating diabetes using insulin, and explicitly assessed during ten follow-up visits ($t$ is the years since baseline visit). 

```{r libraries and dataset, include = FALSE, fig.show = "hide", results = "hide"}
##SET WORKING DIRECTORY TO SOURCE FILE LOCATION

##LIBRARIES
#install.packages("survival")
#install.pacakges("ggplot2)
#install.packages("survminer")
#install.packages("rms")
#install.packages("gmodels")
library(survival)
library(ggplot2)
library(survminer)
library(rms)
library(gmodels)

##LOAD DATA
source("build_survival_dataset_updated.R")

surv.df$race = as.factor(surv.df$race)

surv.df$income = as.factor(surv.df$income)

surv.df$age_group = as.factor(surv.df$age_group)

surv.df$bmi_group = as.factor(surv.df$bmi_group)

surv.df$insured = as.factor(surv.df$insured)

surv.df$event = as.numeric(surv.df$event)

```

```{r Create surv object in surv.df , echo = FALSE}
surv.df$surv_obj = with(surv.df, Surv(t2event, event))
```

Research Objective
--------------------
How does insurance status affect the onset of diabetes among middle-aged American women over nine years? Does this affect remain after controlling for race and household income and age group?

How do race and income affect onset of diabetes among middle-aged American women? Does the affect of race on diabetes onset remain after controlling for household income and age group?

Descriptive Statistics
--------------------------

The mean age at $t = 0$ is 45.899.
```{r descriptives, echo = FALSE}
##MEAN AGE AT t = 0
mean(surv.df$t0_age) 
```
Distribution of the age group upon study entry. This will be our age strata.

```{r, echo = FALSE}
##AGE GROUP DISTRIBUTION
table(surv.df$age_group)
```

Distribution of insurance status at baseline. There are 171 uninsured and 2515 insured women in the study.

```{r, echo = FALSE}
##INSURANCE STATUS
#6.65% of participants report no insurance during screening study
table(surv.df$insured)
```

6.37% of women in the study are uninsured at baseline. 

```{r, echo = FALSE}
nrow(surv.df[surv.df$insured == "No",]) / nrow(surv.df) 
```
Race distribution of the analytical sample ($n = 2686$)

```{r, echo = FALSE}
##RACE
table(surv.df$race)
```

Distribution of self-reported household income at baseline.

```{r, echo = FALSE}
##HOUSEHOLD INCOME
table(surv.df$income)
```

Histogram of continuous BMI. 

```{r, echo = FALSE}
hist(surv.df$t0_bmi)
```

Distribution of BMI groups. There are 186 women in the highest BMI group.

```{r, echo = FALSE}
table(surv.df$bmi_group)
```

Overall incidence of diabetes over the course of the study (10 years). 274 participants out of 2686 developed diabetes during the course of the study.

```{r, echo = FALSE}
##OVERALL EVENT INCIDENCE DURING STUDY
table(surv.df$event)
```


Exploratory Analysis
-------------------

Cross tabulation for race and income. 

```{r, echo = FALSE}
##FACTOR CROSS TABS
ftable(xtabs(~race + income, data = surv.df))

CrossTable(surv.df$race, surv.df$income,
           prop.chisq = FALSE,
           format = "SPSS",
           digits = 2)
```

Cross tabulation for race and insurance status.

```{r, echo = FALSE}
##FACTOR CROSS TABS
ftable(xtabs(~race + insured, data = surv.df))

CrossTable(surv.df$race, surv.df$insured,
           prop.chisq = FALSE,
           format = "SPSS",
           digits = 2)
```

Cross tabulation for BMI and race.

```{r, echo = FALSE}
ftable(xtabs(~race + bmi_group, data = surv.df))

CrossTable(surv.df$race, surv.df$bmi_group,
           prop.chisq = FALSE,
           format = "SPSS",
           digits = 2)
```

Counts of diabetes incidence by race.

```{r, echo = FALSE}
##EVENT INCIDENCE BY RACE
xtabs(~race + event, data = surv.df)
```

Proportion of incidence by race. The proportion of diabetes incidence within each race group appears higher for black and hispanic participants than for other groups.

```{r, echo = FALSE}
xtabs(~race + event, data = surv.df)[,2] / 
  xtabs(~race + event, data = surv.df)[,1]
```


Counts of diabetes incidence by insurance status. 

```{r, echo = FALSE}
##EVENT INCIDENCE BY INSURANCE STATUS
xtabs(~insured + event, data = surv.df)
```

Proportion of diabetes incidence for those without and with insurance. Proportion of diabetes incidence by health insurance status by the end of the study appears higher for those without health insurance at baseline.

```{r, echo = FALSE}
xtabs(~insured + event, data = surv.df)[,2] / 
  xtabs(~insured + event, data = surv.df)[,1]
```

Counts for diabetes incidence by household income at baseline.

```{r, echo = FALSE}
##EVENT INCIDENCE BY HOUSEHOLD INCOME
xtabs(~income + event, data = surv.df)
```

Proportion of diabetes incidence by household income at baseline. The proportion of diabetes incidence within each household income group by end of study appears higher for lower income groups.

```{r, echo = FALSE}
xtabs(~income + event, data = surv.df)[,2] / 
  xtabs(~income + event, data = surv.df)[,1]
```

Counts of diabetes incidence by baseline BMI group status.

```{r, echo =  FALSE}
xtabs(~bmi_group + event, data = surv.df)
```

Proportion of diabetes incidence by baseline BMI group. 52.46% of women with a baseline BMI 40 or above developed diabetes over the course of the study. 21.90% of women with a BMI greater than 30 and strictly less than 40 developed diabetes over the course of the study. Just 5.38% of women with a baseline BMI strictly less than 30 developed diabetes during the course of the study. 

```{r, echo = FALSE}
xtabs(~bmi_group + event, data = surv.df)[,2] / 
  xtabs(~bmi_group + event, data = surv.df)[,1]
```

Stratified Cox Models
--------------------------

We build a stratified Cox model with diabetes survival depending only on health insurance status and stratified by age group. The hazard ratio for those with insurance is 0.375 which appears significant at $\alpha = 0.001$. To assess the validity of this output, we proceed to model diagnostics to assess the proportional hazards and no-interaction assumptions.

```{r insurance only, echo = FALSE}
##STRATIFIED COX MODEL WITH INSURANCE STRATIFIED BY AGE GROUP

#BUILD MODEL
dbts.mod.ins= coxph(surv_obj ~ insured + strata(age_group), 
                    data = surv.df)
dbts.mod.ins

```

We assess the proportional hazards assumption for the above model using a Goodness-of-Fit test based on the Schoenfeld residuals (Grambsch & Therneau, 1994). The proportional hazards assumption is met since the p-value is not significant ($p = 0.20$). Using the plot of the residuals below, we can see that the hazard ratio is nearly constant over time.

```{r, echo = FALSE}

##PH ASSUMPTION
cox.zph(dbts.mod.ins)
plot(cox.zph(dbts.mod.ins), 
     main = "Scaled Schoenfeld Residuals (~insured + strata(age_group)")
```

The coefficient estimates of separate models by age strata do not appear greatly different. We confirm that there is no significant interaction between the strata and insurance status with a Chi-Squared test of model difference with 2 degrees of freedom. 

```{r, echo = FALSE}
##NO INTERACTION ASSUMPTION
#The coefficients do not appear very different
coxph(surv_obj ~ insured, 
      data = surv.df[surv.df$age_group == "42_45",])
coxph(surv_obj ~ insured, 
      data = surv.df[surv.df$age_group == "46_49",])
coxph(surv_obj ~ insured, 
      data = surv.df[surv.df$age_group == "50_53",])

#stratified interaction model w/o main effect of age group
dbts.mod.interaction = coxph(surv_obj ~ insured*age_group - age_group + strata(age_group),
      data = surv.df)
dbts.mod.interaction

#interaction not significant
anova(dbts.mod.interaction, dbts.mod.ins)

```

We construct a stratified Cox model of diabetes survival depending on insurance status, race, BMI, and household income stratified by age group. 

```{r all factors, echo = FALSE}
##STRATIFIED COX MODEL WITH INSURANCE, RACE, AND INCOME, STRATIFIED BY AGE
#BUILD MODEL
dbts.mod.all = coxph(surv_obj ~ insured + race + income + strata(age_group), data = surv.df)
dbts.mod.all
```

We assess the proportional hazards assumption for the above model using a Goodness-of-Fit test based on the Schoenfeld residuals (Grambsch & Therneau, 1994). 

```{r, echo = FALSE}
#PH ASSUMPTION
cox.zph(dbts.mod.all)
par(mfrow = c(2,2))
plot(cox.zph(dbts.mod.all))
```

Using a Chi-squared test for model differences, we evaluate the no-interaction assumption for the strata and the covariates.

```{r, echo = FALSE}
#NO INTERACTION ASSUMPTION
coxph(surv_obj ~ insured + race + income, data = surv.df[surv.df$age_group == "42_45",])
coxph(surv_obj ~ insured + race + income, data = surv.df[surv.df$age_group == "46_49",])
coxph(surv_obj ~ insured + race + income, data = surv.df[surv.df$age_group == "50_54",])

dbts.mod.all.interaction = coxph(surv_obj ~ (insured + race + income)*age_group - age_group + strata(age_group), data = surv.df)
dbts.mod.all.interaction

#chi-squared test for significance of interaction
anova(dbts.mod.all.interaction, dbts.mod.all)
```

We finally construct a model with only the significant factors found in the previous model, household income and race, and stratified by age. Using a Chi-Squared test of model difference, we find that the model including insurance status is not significantly better than the model without insurance status. The proportional hazards assumption is met for both race and income. A Chi-Squared test of deviances with 14 degrees of freedom finds no significant difference between the model including an interaction between age group and the covariates ($p = 0.820$), so the no interaction assumption for stratified Cox models is also satisfied.

```{r reduced model, echo = FALSE}
##STRATIFIED COX MODEL WITH RACE AND INCOME, AND STRATIFIED BY AGE
#BUILD MODEL
dbts.mod.noinsure = coxph(surv_obj ~ race + income + strata(age_group), data = surv.df)
dbts.mod.noinsure

#LRT Chi-Sq test for models
anova(dbts.mod.noinsure, dbts.mod.all)
```

We assess the proportional hazards assumption for the above model using a Goodness-of-Fit test based on the Schoenfeld residuals (Grambsch & Therneau, 1994).

```{r, echo = FALSE}
#PH ASSUMPTION
cox.zph(dbts.mod.noinsure)
par(mfrow = c(1,2))
plot(cox.zph(dbts.mod.noinsure))
```

We assess the no-interaction assumption between the strata and the covariates using a Chi-squared test of model difference.

```{r, echo = FALSE}
#NO INTERACTION ASSUMPTION
coxph(surv_obj ~ race + income, data = surv.df[surv.df$age_group == "42_45",])
coxph(surv_obj ~ race + income, data = surv.df[surv.df$age_group == "46_49",])
coxph(surv_obj ~ race + income, data = surv.df[surv.df$age_group == "50_54",])

dbts.mod.noinsure.interaction = coxph(surv_obj ~ (race + income)*age_group - age_group + strata(age_group), data = surv.df)
dbts.mod.noinsure.interaction

#Chi-Squared test of deviance
anova(dbts.mod.noinsure.interaction, dbts.mod.noinsure)

```

We find that the hazard ratios for diabetes incidence for Hispanic and Black/African Americans are 0.753 and 1.027 respectively, indicating higher risk for diabetes onset compared to White Americans, after adjusting for income and age ($p < 0.001$ for Black/African Americans, $p < 0.001$ for Hispanic Americans). Household income is also found to be significant, with lower income women at higher risk than their wealthiest counterparts. The risk for diabetes increases with distance from the highest income group.

```{r selected model summary, echo = FALSE}
#MODEL SUMMARY
dbts.mod.noinsure
```

Kaplain-Meier Curves
------------------------------

```{r 42_45, echo = FALSE}
km42_45 = survfit(surv_obj ~ insured, 
                  data = surv.df[surv.df$age_group=="42_45",])
ggsurvplot(km42_45, 
           data = surv.df[surv.df$age_group=="42_45",], 
           conf.int=FALSE, 
           xlab = "Time (t)", 
           ylab = "Survival Probability", 
           title = "Diabetes Survival versus Time Since Study Entry (Age at t = 0, 42-45)",
           legend = "none",
           ylim = c(0.6, 1.0),
           risk.table = TRUE,
           risk.table.height = .5,
           break.x.by = 1,
           fontsize = 3)
```

```{r 46_49, echo = FALSE}
km46_49 = survfit(surv_obj ~ insured, 
                  data = surv.df[surv.df$age_group=="46_49",])
ggsurvplot(km46_49, 
           data = surv.df[surv.df$age_group=="46_49",], 
           conf.int=FALSE, 
           xlab = "Time (t)", 
           ylab = "Survival Probability", 
           title = "Diabetes Survival versus Time Since Study Entry (Age at t = 0, 46-49)",
           legend = "none",
           ylim = c(0.6, 1.0),
           risk.table = TRUE,
           risk.table.height = .5,
           break.x.by = 1,
           fontsize = 3)
```

```{r 50_53, echo = FALSE}
km50_54 = survfit(surv_obj ~ insured, 
                  data = surv.df[surv.df$age_group=="50_53",])
ggsurvplot(km50_53, 
           data = surv.df[surv.df$age_group=="50_53",], 
           conf.int=FALSE, 
           xlab = "Time (t)", 
           ylab = "Survival Probability", 
           title = "Diabetes Survival versus Time Since Study Entry (Age at t = 0, 50-53)",
           legend = "none",
           ylim = c(0.6, 1.0),
           risk.table = TRUE,
           risk.table.height = .5,
           break.x.by = 1,
           fontsize = 3)
```




